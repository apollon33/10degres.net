<blockquote>
  <p>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it? 
Files for this level can be found in /home/flag02.</p>
</blockquote>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
  
  <span class="n">gid_t</span> <span class="n">gid</span><span class="p">;</span>
  <span class="n">uid_t</span> <span class="n">uid</span><span class="p">;</span>
  
  <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
  <span class="n">uid</span> <span class="o">=</span> <span class="n">geteuid</span><span class="p">();</span>
  
  <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
  <span class="n">setresuid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
  
  <span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  
  <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"/bin/echo %s is cool"</span><span class="p">,</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"USER"</span><span class="p">));</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"about to call system(</span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
  
  <span class="n">system</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>As the previous level, we here have a suid executable, owned by our target <code class="highlighter-rouge">flag02</code>, who uses an environment variable <code class="highlighter-rouge">USER</code> to print a super cool message. 
<!--more-->
Let’s try it:</p>

<p><a href="/images/exploit_exercices_nebula_level02_1.png"><img src="/images/exploit_exercices_nebula_level02_1.png" alt="Exploit Exercises Nebula Level02" /></a></p>

<p>Note the lack of filter when the environment variable is used. 
Usually it contains the current user login but let’s check her content:</p>

<p><a href="/images/exploit_exercices_nebula_level02_2.png"><img src="/images/exploit_exercices_nebula_level02_2.png" alt="Exploit Exercises Nebula Level02" /></a></p>

<p>Since environment variable can be easily altered, we can use it to call <code class="highlighter-rouge">getflag</code>:</p>

<p><a href="/images/exploit_exercices_nebula_level02_3.png"><img src="/images/exploit_exercices_nebula_level02_3.png" alt="Exploit Exercises Nebula Level02" /></a></p>

<p>Or anything else :</p>

<p><a href="/images/exploit_exercices_nebula_level02_4.png"><img src="/images/exploit_exercices_nebula_level02_4.png" alt="Exploit Exercises Nebula Level02" /></a></p>
